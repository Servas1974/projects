<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Обновленная HTML-страница</title>
  <style>
    /* Ваши существующие стили */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      color: #333;
    }

    h1 {
      color: #0056b3;
      text-align: center;
      margin-bottom: 30px;
    }

    h2 {
      color: #0069d9;
      text-align: center;
      margin-top: 40px;
      margin-bottom: 20px;
    }

    table {
      width: 500px;
      /* Остается для первой таблицы */
      margin: 10px auto;
      border-collapse: collapse;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      background-color: #fff;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }

    th {
      background-color: #007bff;
      color: white;
      text-transform: uppercase;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #f8f8f8;
    }

    tr:hover {
      background-color: #e9ecef;
    }

    .button-container {
      text-align: center;
      margin-top: 40px;
      margin-bottom: 20px;
      /* Добавляем flexbox для кнопок, чтобы они могли располагаться вертикально на любом экране */
      display: flex;
      flex-direction: column;
      /* Располагаем элементы в колонку */
      align-items: center;
      /* Центрируем по горизонтали */
      gap: 15px;
      /* Добавляем промежуток между кнопками */
    }

    .action-button {
      background-color: #28a745;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      /* Убираем фиксированный margin, используем gap в button-container */
      /* margin: 0 10px; */
      width: 200px;
      /* Фиксированная ширина для кнопок */
      max-width: 90%;
      /* Но не более 90% ширины родителя */
    }

    .action-button:hover {
      background-color: #218838;
    }

    .save-button {
      background-color: #007bff;
    }

    .save-button:hover {
      background-color: #0056b3;
    }

    /* --- СТИЛИ ДЛЯ ВТОРОЙ ТАБЛИЦЫ --- */
    .schedule-table {
      width: 300px;
      /* Фиксированная очень маленькая ширина */
      margin: 5px auto;
      /* Центрируем */
      border-collapse: collapse;
      box-shadow: 0 2px 1px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      table-layout: fixed;
      /* Важно, чтобы ширина колонок соблюдалась */
    }

    /* Применяем ширину к заголовкам и ячейкам второй таблицы */
    .schedule-table th,
    .schedule-table td {
      padding: 8px 3px;
      /* Уменьшаем паддинг для компактности */
      font-size: 0.8em;
      /* Уменьшаем размер шрифта */
    }

    .schedule-table td:nth-child(1) {
      width: 160px;
      /* Ширина для колонки "Время" */
    }

    .schedule-table td:nth-child(2) {
      width: 140px;
      /* Ширина для колонки "Количество" */
    }

    /* Общие стили для всех input-полей внутри редактируемых ячеек */
    .schedule-table input {
      width: 140px;
      /* Занимает почти всю ширину ячейки */
      box-sizing: border-box;
      padding: 3px;
      /* Уменьшаем паддинг */
      border: 1px solid #ccc;
      border-radius: 3px;
      text-align: center;
      font-size: inherit;
    }

    /* *** ИСПРАВЛЕННЫЕ СТИЛИ: ПРИМЕНЯЮТСЯ ТОЛЬКО КОГДА ТАБЛИЦА В РЕЖИМЕ РЕДАКТИРОВАНИЯ *** */
    .schedule-table.edit-mode-active td:nth-child(1) {
      width: 140px;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1;
      /* Убираем padding у ячейки для максимального использования пространства */
    }

    .schedule-table.edit-mode-active td:nth-child(1) input {
      width: 50px;
      /* Каждое поле займет 45% ширины, чтобы поместился разделитель */
      margin: 0 1%;
      /* Небольшой горизонтальный отступ между полями */
      padding: 3px;
      /* Уменьшаем паддинг внутри инпута */
    }

    .schedule-table.edit-mode-active td:nth-child(1) span.time-separator {
      display: inline-block;
      width: 4px;
      /* Корректируем ширину двоеточия */
      text-align: center;
      font-weight: bold;
      font-size: 1em;
      /* Уменьшаем размер шрифта двоеточия */
    }
  </style>
</head>

<body>

  <h1>Питание для друга</h1>

  ---

  <h2>Текущее состояние</h2>
  <table>
    <thead>
      <tr>
        <th>Температура</th>
        <th>Влажность</th>
        <th>Напряжение</th>
        <th>Средний ток последнего цикла</th>
        <th>Время последнего цикла</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="tempValue">--</td>
        <td id="humidityValue">--</td>
        <td id="voltageValue">--</td>
        <td id="currentValue">--</td>
        <td id="fullTimeValue">--</td>
      </tr>
      <tr>
        <td>°С</td>
        <td>­%</td>
        <td>В</td>
        <td>mA</td>
        <td id="statusMessage">--</td>
      </tr>
    </tbody>
  </table>

  ---

  <h2>Расписание</h2>
  <table class="schedule-table" id="scheduleTable">
    <thead>
      <tr>
        <th>Время</th>
        <th>Количество</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>07:30</td>
        <td>5</td>
      </tr>
      <tr>
        <td>13:00</td>
        <td>4</td>
      </tr>
      <tr>
        <td>19:45</td>
        <td>3</td>
      </tr>
      <tr>
        <td>00:00</td>
        <td>0</td>
      </tr>
      <tr>
        <td>00:00</td>
        <td>0</td>
      </tr>
      <tr>
        <td>Ручной</td>
        <td>7</td>
      </tr>
    </tbody>
  </table>

  <div class="button-container">
    <button class="action-button" id="editButton">Изменить</button>
    <button class="action-button" id="runButton">Запустить</button>
    <button class="action-button save-button" id="saveButton" style="display: none;">Сохранить</button>
  </div>

  <script>
    // Замените YOUR_CHANNEL_ID и YOUR_READ_API_KEY на свои данные ThingSpeak
    // Если ваш канал ThingSpeak публичный, Read API Key не нужен.
    const CHANNEL_ID1 = '3002399'; // Например, 123456
    const READ_API_KEY1 = '2R940E9A2PA5O91X'; // Опционально, если канал приватный
    // URL для получения последних данных из ThingSpeak
    // 'results=1' получает только последнюю запись
    // Замените field1, field2 и т.д. на номера полей, которые вы используете в ThingSpeak
    const API_URL1 = `https://api.thingspeak.com/channels/${CHANNEL_ID1}/feeds.json?results=1&api_key=${READ_API_KEY1}`;
    async function fetchThingSpeakData() {
      try {
        const response = await fetch(API_URL1);
        const data = await response.json();
        if (data && data.feeds && data.feeds.length > 0) {
          const latestFeed = data.feeds[0];
          // Обновляем значения в таблице
          // Убедитесь, что field1, field2 и т.д. соответствуют вашим полям в ThingSpeak
          document.getElementById('voltageValue').textContent = latestFeed.field1 || 'N/A';
          document.getElementById('currentValue').textContent = latestFeed.field2 || 'N/A';
          document.getElementById('tempValue').textContent = latestFeed.field3 || 'N/A';
          document.getElementById('humidityValue').textContent = latestFeed.field4 || 'N/A';
          const hours = parseInt(latestFeed.field5); // Предполагаем, что field5 - это часы
          const minutes = parseInt(latestFeed.field6); // Предполагаем, что field6 - это минуты
          const formattedHours = String(hours).padStart(2, '0');
          const formattedMinutes = String(minutes).padStart(2, '0');
          timeString = `${formattedHours}:${formattedMinutes}`;
          document.getElementById('fullTimeValue').textContent = timeString;
          const field7Value = parseInt(latestFeed.field7); // Получаем значение из field7
          switch (field7Value) {
            case 1:
              statusText = 'Исправен';
              break;
            case 2:
              statusText = 'Низкий заряд батареи';
              break;
            case 3:
              statusText = 'Бункер пустой';
              break;
            case 4:
              statusText = 'Перегрузка двигателя';
              break;
            case 5:
              statusText = 'В работе ...';
              break;
            default:
              statusText = 'Неизвестный статус'; // Если значение не 1, 2, 3 или 4
          }
          document.getElementById('statusMessage').textContent = statusText;
          // Для времени можно использовать 'created_at' и отформатировать
          //const createdAt = new Date(latestFeed.created_at);
          //document.getElementById('timeValue').textContent = createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
      } catch (error) {
        console.error('Ошибка при получении данных с ThingSpeak:', error);
        // Обработка ошибок, например, отображение сообщения об ошибке на странице
      }
    }
    // Вызываем функцию при загрузке страницы
    fetchThingSpeakData();
    // Можно настроить периодическое обновление данных, например, каждые 30 секунд (30000 мс)
    setInterval(fetchThingSpeakData, 180000);
    // --- КОД ДЛЯ РЕДАКТИРОВАНИЯ ТАБЛИЦЫ ---
    const scheduleTable = document.getElementById('scheduleTable');
    const editButton = document.getElementById('editButton');
    const saveButton = document.getElementById('saveButton');
    const runButton = document.getElementById('runButton'); // Кнопка "Запустить"
    let cellOriginalContents = new Map();
    let scheduleData = []; // Переменная для хранения данных расписания
    editButton.addEventListener('click', () => {
      // Добавляем класс, чтобы активировать стили редактирования
      scheduleTable.classList.add('edit-mode-active');
      const rows = scheduleTable.querySelectorAll('tbody tr');
      cellOriginalContents.clear();
      rows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, cellIndex) => {
          cellOriginalContents.set(cell, cell.textContent);
          const isLastRowFirstColumnManual = (rowIndex === rows.length - 1 && cells[0].textContent.trim().toLowerCase() === 'ручной' && cellIndex === 0);
          if (isLastRowFirstColumnManual) {
            return;
          }
          if (cellIndex === 0) { // Первый столбец (Время)
            const timeParts = cell.textContent.split(':');
            let hours = parseInt(timeParts[0], 10);
            let minutes = parseInt(timeParts[1], 10);
            if (isNaN(hours)) hours = 0;
            if (isNaN(minutes)) minutes = 0;
            const hourInput = document.createElement('input');
            hourInput.type = 'number';
            hourInput.value = String(hours).padStart(2, '0');
            hourInput.min = '0';
            hourInput.max = '23';
            const minuteInput = document.createElement('input');
            minuteInput.type = 'number';
            minuteInput.value = String(minutes).padStart(2, '0');
            minuteInput.min = '0';
            minuteInput.max = '59';
            const colonSpan = document.createElement('span');
            colonSpan.textContent = ':';
            colonSpan.classList.add('time-separator');
            cell.textContent = '';
            cell.appendChild(hourInput);
            cell.appendChild(colonSpan);
            cell.appendChild(minuteInput);
          } else { // Второй столбец (Количество)
            const DoseInput = document.createElement('input');
            DoseInput.type = 'number';
            DoseInput.value = cell.textContent;
            DoseInput.min = '0';
            DoseInput.max = '9';
            cell.textContent = '';
            cell.appendChild(DoseInput);
          }
        });
      });
      editButton.style.display = 'none';
      runButton.style.display = 'none';
      saveButton.style.display = 'inline-block';
    });
    saveButton.addEventListener('click', () => {
      // Удаляем класс, чтобы вернуть стили к нормальному отображению
      scheduleTable.classList.remove('edit-mode-active');
      const rows = scheduleTable.querySelectorAll('tbody tr');
      const tempScheduleData = [];
      rows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td');
        let currentEntry = {};
        const isLastRowManual = (rowIndex === rows.length - 1 && cells[0].textContent.trim().toLowerCase() === 'ручной');
        if (isLastRowManual) {
          currentEntry.mode = 'Ручной';
          const quantityInput = cells[1].querySelector('input');
          if (quantityInput) {
            currentEntry.quantity = quantityInput.value;
            cells[1].textContent = quantityInput.value;
          } else {
            currentEntry.quantity = cells[1].textContent;
          }
          cells[0].textContent = cellOriginalContents.get(cells[0]);
        } else {
          const hourInput = cells[0].querySelector('input[type="number"]:first-of-type');
          const minuteInput = cells[0].querySelector('input[type="number"]:last-of-type');
          const quantityInput = cells[1].querySelector('input');
          if (hourInput && minuteInput) {
            const hours = String(Math.max(0, Math.min(23, parseInt(hourInput.value, 10) || 0))).padStart(2, '0');
            const minutes = String(Math.max(0, Math.min(59, parseInt(minuteInput.value, 10) || 0))).padStart(2, '0');
            currentEntry.hours = hours;
            currentEntry.minutes = minutes;
            cells[0].textContent = `${hours}:${minutes}`;
          } else {
            const timeParts = cells[0].textContent.split(':');
            currentEntry.hours = timeParts[0] || '00';
            currentEntry.minutes = timeParts[1] || '00';
          }
          if (quantityInput) {
            currentEntry.quantity = quantityInput.value;
            cells[1].textContent = quantityInput.value;
          } else {
            currentEntry.quantity = cells[1].textContent;
          }
        }
        tempScheduleData.push(currentEntry);
      });
      scheduleData = tempScheduleData;
      console.log('Структурированные данные расписания готовы:', scheduleData);
      editButton.style.display = 'inline-block';
      runButton.style.display = 'inline-block';
      saveButton.style.display = 'none';
    });
  </script>

</body>

</html>
