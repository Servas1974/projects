<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>EVSE "Рожевий будинок"</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    h1 {
      margin-left: 200px;
    }

    table {
      border-collapse: collapse;
      width: auto;
      margin-bottom: 20px;
      margin-left: 50px;
    }

    th,
    td {
      border: 1px solid black;
      padding: 8px;
      text-align: center;
      /* Центрирование содержимого */
    }

    caption {
      font-weight: bold;
      text-align: left;
      margin-bottom: 5px;
    }

    .purple-header th {
      background-color: lightgreen;
      /* Изменен на зеленый */
      color: white;
    }

    .purple-header tbody tr:nth-child(2) th:first-child {
      background-color: green;
      /* Светло-зеленый для первой ячейки 3-й строки */
    }

    .purple-header tbody tr:nth-child(3) th:first-child {
      background-color: orange;
    }
  </style>
</head>

<body>

  <h1>EVSE "Рожевий будинок"</h1>

  <table>
    <caption>Статус пристрою</caption>
    <thead style="background-color: blue; color: white;">
      <tr>
        <th>Напруга, В</th>
        <th>Струм, А</th>
        <th>Потужність,<br>кВт</th>
        <th>Частота,<br>Гц</th>
        <th>cos &#966</th>
        <th>Температура,<br>&deg;C</th>
        <th>Поточний лічильник,<br>кВт*год</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <table>
    <caption>Поточний режим</caption>
    <thead style="background-color: yellow;">
      <tr>
        <th>Режим</th>
        <th>Користувач</th>
        <th colspan="2">Час підключення,<br>год|хв</th>
        <th>Спожита енергія,<br>Вт*год</th>
        <th>Помилка</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <table class="purple-header">
    <caption>Інформація про користувачив у звітноьому періоді</caption>
    <thead>
      <tr>
        <th></th>
        <th>Сергій 98</th>
        <th>Євген 07</th>
        <th>Артем</th>
        <th>Сергій 68</th>
        <th>User5</th>
        <th>User6</th>
        <th>User7</th>
        <th>User8</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>Спожита енергія,<br>кВт*год</th>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
      <tr>
        <th>Енергія до сплати,<br>кВт*год</th>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
      <tr>
        <th>Несплачено у попередньому<br>періоді, кВт*год</th>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    </tbody>
  </table>

</body>

</html>
<script>
  const CHANNEL_1_ID = '2219372';
  const CHANNEL_1_KEY = '09SKRQXNSOIWRJ04';
  const CHANNEL_2_ID = '2847233';
  const CHANNEL_2_KEY = 'O5B444F5OB5OJ010';
  const CHANNEL_3_ID = '3021770';
  const CHANNEL_3_KEY = '93PAQ6CZB0C6DI5Q';
  const THING_SPEAK_URL_1 = `https://api.thingspeak.com/channels/${CHANNEL_1_ID}/feeds.json?api_key=${CHANNEL_1_KEY}&results=1`;
  const THING_SPEAK_URL_2 = `https://api.thingspeak.com/channels/${CHANNEL_2_ID}/feeds.json?api_key=${CHANNEL_2_KEY}&results=1`;
  const THING_SPEAK_URL_3 = `https://api.thingspeak.com/channels/${CHANNEL_3_ID}/feeds.json?api_key=${CHANNEL_3_KEY}&results=1`;
  async function fetchDataAndFillTables() {
    try {
      const [response1, response2, response3] = await Promise.all([
        fetch(THING_SPEAK_URL_1),
        fetch(THING_SPEAK_URL_2),
        fetch(THING_SPEAK_URL_3)
      ]);
      const data1 = await response1.json();
      const data2 = await response2.json();
      const data3 = await response3.json();
      if (data1.feeds && data1.feeds.length > 0) {
        Energy = data1.feeds[0].field7;
        fillTable1(data1.feeds[0]);
        fillTable22(data1.feeds[0]);
      }
      console.log(data2.feeds)
      if (data2.feeds && data2.feeds.length > 0) {
        fillTable2(data2.feeds[0]);
      }
      if (data3.feeds && data3.feeds.length > 0) {
        fillTable3(data3.feeds[0]);
      }
    } catch (error) {
      console.error("Ошибка при получении данных с ThingSpeak:", error);
    }
  }

  function fillTable1(data) {
    const table = document.querySelector('body > table:nth-of-type(1) tbody tr');
    if (table) {
      const cells = table.querySelectorAll('td');
      cells[0].textContent = data.field1;
      cells[1].textContent = data.field2;
      cells[2].textContent = data.field5;
      cells[3].textContent = data.field3;
      cells[4].textContent = data.field4;
      cells[5].textContent = data.field8;
      cells[6].textContent = data.field7;
    }
  }

  function fillTable2(data) {
    const table = document.querySelector('body > table:nth-of-type(2) tbody tr');
    if (table) {
      const cells = table.querySelectorAll('td');
      const modeDescriptions = {
        '1': 'Готовність',
        '2': 'Підключено',
        '3': 'Очикування',
        '4': 'Помилка',
        '5': 'Заряджання',
        '7': 'Відмова'
      };
      const errorDescriptions = {
        '0': 'Немає',
        '1': 'Коннектор',
        '2': 'Тест RCMU',
        '3': 'Заземлення',
        '4': 'Перегрів'
      };
      const userDescriptions = {
        '0': 'Немає',
        '1': 'Сергій 98',
        '2': 'Євген 07',
        '3': 'Артем',
        '4': 'Сергій 68',
        '5': 'Власник'
      };
      const modeText = modeDescriptions[data.field4[data.field4.length - 1]];
      const errorText = errorDescriptions['0'];
      const userText = userDescriptions[data.field1];
      if (data.field4.length > 1) {
        errorText = errorDescriptions[data.field4[0]];
      }
      cells[0].textContent = modeText;
      const hours = String(data.field2).padStart(2, '0');
      const minutes = String(data.field3).padStart(2, '0');
      cells[1].textContent = userText;
      cells[2].textContent = hours;
      cells[3].textContent = minutes;
      cells[5].textContent = errorText || "Немає";
    }
  }

  function fillTable22(data) {
    const table = document.querySelector('body > table:nth-of-type(2) tbody tr');
    if (table) {
      const cells = table.querySelectorAll('td');
      cells[4].textContent = data.field6;
    }
  }

  function fillTable3(data) {
    const table = document.querySelector('body > table:nth-of-type(3) tbody');
    if (table) {
      const rows = table.querySelectorAll('tr');
      const firstRowCells = rows[0].querySelectorAll('td');
      const secondRowCells = rows[1].querySelectorAll('td');
      // Заполняем первую строку (Спожита енергія, кВт*год)
      firstRowCells[0].textContent = data.field1;
      firstRowCells[1].textContent = data.field2;
      firstRowCells[2].textContent = data.field3;
      firstRowCells[3].textContent = data.field4;
      firstRowCells[4].textContent = data.field5;
      firstRowCells[5].textContent = data.field6;
      firstRowCells[6].textContent = data.field7;
      firstRowCells[7].textContent = data.field8;
      // Заполняем вторую строку (Енергія до сплати, кВт*год) на основе вычислений
      const koefPart = parseFloat(data.field1) / (parseFloat(Energy) - parseFloat(data.field1));
      secondRowCells[0].textContent = 0;
      secondRowCells[1].textContent = (parseFloat(data.field2) * koefPart + parseFloat(data.field2)).toFixed(1);
      secondRowCells[2].textContent = (parseFloat(data.field3) * koefPart + parseFloat(data.field3)).toFixed(1);
      secondRowCells[3].textContent = (parseFloat(data.field4) * koefPart + parseFloat(data.field4)).toFixed(1);
      secondRowCells[4].textContent = (parseFloat(data.field5) * koefPart + parseFloat(data.field5)).toFixed(1);
    }
  }
  document.addEventListener('DOMContentLoaded', fetchDataAndFillTables);
</script>
